language: php

sudo: false

php: 7.1

env:
    global:
        # Token for generate-api.sh, so Travis is able to push to "apigen/Api repository
        # It must be encrypted in https://github.com/ApiGen/api local repository
        # See manual how to set it up: https://github.com/TomasVotruba/tomasvotruba.cz/blob/08f0df06674c6bc9db224a69250b8e95060cdc96/.travis.yml#L6-L15

install:
    - composer require apigen/apigen

script:
    - phpenv config-rm xdebug.ini || return 0
    
after_script:
    # Generate ApiGen's api a push it to https://github.com/apigen/apigen, gh-pages branch
    - mkdir ../../docs/
    - |
        if [[ $TRAVIS_BRANCH == "master" ]]; then
          # Generate API for ApiGen
          bin/apigen generate ../apigen-boilerplate/ --destination ../../docs/
          # use this, when ApiGen is faster
          # bin/apigen generate src packages/*/src --destination temp/api
          cd ../../docs/

          # Add this repository as remote
          git init
          git remote add origin https://${GH_TOKEN}@github.com/vsp-libs/apigen-boilerplate.git

          # Set Travis to Git Identity
          git config --global user.email "travis@travis-ci.org"
          git config --global user.name "Travis"

          # Add generated API
          git add .
          git commit -m "API Regenerated"
          # Push current content to gh-pages branch
          git push origin master:gh-pages -f
        fi
